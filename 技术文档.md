# ğŸ“š æŠ€æœ¯æ–‡æ¡£

## ç›®å½•

1. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
2. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
3. [å®¹å™¨åŒ–æ–¹æ¡ˆ](#å®¹å™¨åŒ–æ–¹æ¡ˆ)
4. [Bug ä¿®å¤è®°å½•](#bug-ä¿®å¤è®°å½•)

---

## ğŸ¨ å‰ç«¯æ¶æ„

### Vue3 + Nginx é…ç½®

#### ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šé…ç½®ï¼Ÿ

Vue Router ä½¿ç”¨ **History æ¨¡å¼**æ—¶ï¼Œæ‰€æœ‰è·¯ç”±åœ¨å‰ç«¯å¤„ç†ã€‚å½“ç”¨æˆ·ç›´æ¥è®¿é—®æˆ–åˆ·æ–°é¡µé¢æ—¶ï¼ˆå¦‚ `/register`ï¼‰ï¼ŒNginx ä¼šå°è¯•æŸ¥æ‰¾ `/register` æ–‡ä»¶ï¼Œå¯¼è‡´ 404ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** é…ç½® Nginx å°†æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ° `index.html`ï¼Œè®© Vue Router å¤„ç†è·¯ç”±ã€‚

---

### Nginx é…ç½®

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/javascript application/javascript application/json;

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API åå‘ä»£ç†åˆ°åç«¯
    location /api/ {
        proxy_pass http://backend-service:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Vue Router History æ¨¡å¼æ”¯æŒ
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
    }
}
```

**å…³é”®é…ç½®è¯´æ˜ï¼š**

1. **SPA è·¯ç”±æ”¯æŒ**
   ```nginx
   location / {
       try_files $uri $uri/ /index.html;
   }
   ```
   - é¦–å…ˆå°è¯•æŸ¥æ‰¾æ–‡ä»¶ `$uri`
   - ä¸å­˜åœ¨åˆ™æŸ¥æ‰¾ç›®å½• `$uri/`
   - éƒ½ä¸å­˜åœ¨åˆ™è¿”å› `index.html`

2. **API åå‘ä»£ç†**
   - å°† `/api/` è¯·æ±‚ä»£ç†åˆ° Django åç«¯
   - K8s ç¯å¢ƒä½¿ç”¨ Service åç§° `backend-service`

3. **é™æ€èµ„æºç¼“å­˜**
   - å¯¹é™æ€èµ„æºè®¾ç½®é•¿æ—¶é—´ç¼“å­˜
   - æé«˜åŠ è½½æ€§èƒ½

---

### Vite é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  
  // å¼€å‘æœåŠ¡å™¨
  server: {
    port: 5173,
    host: '0.0.0.0',
    
    // API ä»£ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  },
  
  // æ„å»ºé…ç½®
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    minify: 'esbuild',
    
    // åˆ†åŒ…ç­–ç•¥
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'axios-vendor': ['axios']
        }
      }
    },
    
    esbuild: {
      drop: ['console', 'debugger'] // ç”Ÿäº§ç¯å¢ƒç§»é™¤
    }
  }
})
```

---

### Vue Router é…ç½®

```javascript
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  
  routes: [
    {
      path: '/login',
      name: 'login',
      component: () => import('../views/Login.vue')
    },
    {
      path: '/register',
      name: 'register',
      component: () => import('../views/Register.vue')
    },
    {
      path: '/',
      name: 'home',
      component: () => import('../views/Home.vue'),
      meta: { requiresAuth: true }
    }
  ]
})

// è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('access_token')
  
  if (to.meta.requiresAuth && !token) {
    next({ name: 'login' })
  } else if (to.name === 'login' && token) {
    next({ name: 'home' })
  } else {
    next()
  }
})

export default router
```

---

### Axios é…ç½®ï¼ˆå¸¦ Token æ‹¦æˆªå™¨ï¼‰

```javascript
import axios from 'axios'
import router from '../router'

const request = axios.create({
  baseURL: '/api',
  timeout: 10000
})

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ  Token
request.interceptors.request.use(
  config => {
    const token = localStorage.getItem('access_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  error => Promise.reject(error)
)

// å“åº”æ‹¦æˆªå™¨ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
request.interceptors.response.use(
  response => response.data,
  async error => {
    if (error.response) {
      switch (error.response.status) {
        case 401:
          localStorage.removeItem('access_token')
          localStorage.removeItem('refresh_token')
          router.push('/login')
          break
        case 403:
          console.error('æ²¡æœ‰æƒé™')
          break
        case 404:
          console.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')
          break
        case 500:
          console.error('æœåŠ¡å™¨é”™è¯¯')
          break
      }
    }
    return Promise.reject(error)
  }
)

export default request
```

---

### å¤šé˜¶æ®µ Dockerfileï¼ˆå‰ç«¯ï¼‰

```dockerfile
# ============ é˜¶æ®µ 1ï¼šæ„å»º ============
FROM node:18-alpine AS builder

# é…ç½®å›½å†… Alpine é•œåƒæº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# é…ç½® npm é•œåƒæºå¹¶å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com && \
    npm ci

# å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY . .
RUN npm run build

# ============ é˜¶æ®µ 2ï¼šè¿è¡Œ ============
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
```

**ä¼˜åŒ–è¯´æ˜ï¼š**
- å¤šé˜¶æ®µæ„å»ºï¼Œæœ€ç»ˆé•œåƒä»… 53MB
- ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿ
- åŒ…å«å¥åº·æ£€æŸ¥

---

## ğŸ”§ åç«¯æ¶æ„

### Django + DRF é…ç½®

#### æ•°æ®åº“é…ç½®

```python
# backend/config/settings.py

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME', 'logindb'),
        'USER': os.getenv('DB_USER', 'postgres'),
        'PASSWORD': os.getenv('DB_PASSWORD', 'postgres123'),
        'HOST': os.getenv('DB_HOST', 'localhost'),
        'PORT': os.getenv('DB_PORT', '5432'),
    }
}
```

#### JWT è®¤è¯é…ç½®

```python
from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': False,
    'BLACKLIST_AFTER_ROTATION': True,
}
```

#### CORS é…ç½®

```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
]

CORS_ALLOW_CREDENTIALS = True
```

---

### å¤šé˜¶æ®µ Dockerfileï¼ˆåç«¯ï¼‰

```dockerfile
# ============ é˜¶æ®µ 1ï¼šæ„å»º ============
FROM python:3.11-alpine AS builder

# é…ç½®å›½å†… Alpine é•œåƒæº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    postgresql-dev \
    gcc \
    python3-dev \
    musl-dev \
    linux-headers

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–ï¼ˆä½¿ç”¨å›½å†…é•œåƒï¼‰
RUN pip install --no-cache-dir --upgrade pip -i https://mirrors.aliyun.com/pypi/simple/ && \
    pip install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/

# ============ é˜¶æ®µ 2ï¼šè¿è¡Œ ============
FROM python:3.11-alpine

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

# é…ç½®å›½å†… Alpine é•œåƒæº
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache postgresql-libs libpq

WORKDIR /app

# å¤åˆ¶ Python åŒ…
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:8000/api/health/ || exit 1

# å¯åŠ¨å‘½ä»¤ï¼šå…ˆè¿ç§»æ•°æ®åº“ï¼Œå†å¯åŠ¨ Gunicorn
CMD ["sh", "-c", "python manage.py migrate && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 60 --access-logfile - --error-logfile -"]
```

**ä¼˜åŒ–è¯´æ˜ï¼š**
- å¤šé˜¶æ®µæ„å»ºï¼Œæœ€ç»ˆé•œåƒ 116MB
- ä½¿ç”¨å›½å†…é•œåƒæºåŠ é€Ÿ
- åŒ…å«æ•°æ®åº“è¿ç§»
- Gunicorn é…ç½® 3 ä¸ª worker

---

## ğŸ³ å®¹å™¨åŒ–æ–¹æ¡ˆ

### é•œåƒå¤§å°å¯¹æ¯”

| é•œåƒ | å¤§å° | è¯´æ˜ |
|------|------|------|
| Frontend | 53MB | Node æ„å»º + Nginx è¿è¡Œ |
| Backend | 116MB | Python 3.11 + PostgreSQL åº“ |
| PostgreSQL | 230MB | å®˜æ–¹ postgres:15-alpine |

### æ„å»ºä¼˜åŒ–æŠ€å·§

1. **ä½¿ç”¨ Alpine Linux**
   - ä½“ç§¯å°ï¼ˆ5MB åŸºç¡€é•œåƒï¼‰
   - åŒ…å«å¸¸ç”¨å·¥å…·

2. **å¤šé˜¶æ®µæ„å»º**
   - æ„å»ºé˜¶æ®µï¼šåŒ…å«ç¼–è¯‘å·¥å…·
   - è¿è¡Œé˜¶æ®µï¼šåªåŒ…å«è¿è¡Œæ—¶ä¾èµ–

3. **å›½å†…é•œåƒæº**
   - Alpine: `mirrors.aliyun.com`
   - PyPI: `mirrors.aliyun.com/pypi/simple/`
   - npm: `registry.npmmirror.com`

4. **å±‚ç¼“å­˜ä¼˜åŒ–**
   - å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶
   - å†å¤åˆ¶æºä»£ç 
   - åˆ©ç”¨ Docker å±‚ç¼“å­˜

---

## ğŸ› Bug ä¿®å¤è®°å½•

### Bug #1: æ³¨å†Œæ¥å£è¿”å› 400

**æ—¶é—´**: 2025-11-27  
**ä½ç½®**: `/api/register/`  
**çŠ¶æ€ç **: 400 Bad Request

#### é—®é¢˜åŸå› 

å‰ç«¯æ³¨å†Œæ—¶ç¼ºå°‘ `password2` å­—æ®µï¼š

```javascript
// âŒ é”™è¯¯
const response = await register({
  username: formData.username,
  email: formData.email,
  password: formData.password
})
```

åç«¯åºåˆ—åŒ–å™¨è¦æ±‚å¿…é¡»åŒ…å« `password2` æ¥ç¡®è®¤å¯†ç ï¼š

```python
class RegisterSerializer(serializers.ModelSerializer):
    password = serializers.CharField(...)
    password2 = serializers.CharField(...)  # å¿…éœ€å­—æ®µ
```

#### è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ `frontend/src/views/Register.vue`ï¼Œæ·»åŠ  `password2` å­—æ®µï¼š

```javascript
// âœ… æ­£ç¡®
const response = await register({
  username: formData.username,
  email: formData.email,
  password: formData.password,
  password2: formData.confirmPassword
})
```

#### éªŒè¯ä¿®å¤

```bash
curl -X POST http://localhost:8080/api/register/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "test123456",
    "password2": "test123456"
  }'
```

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### Bug #2: vite not found

**æ—¶é—´**: 2025-11-27  
**é”™è¯¯**: `sh: vite: not found`

#### é—®é¢˜åŸå› 

Dockerfile ä¸­ä½¿ç”¨ `npm ci --only=production`ï¼Œå¯¼è‡´ `vite`ï¼ˆdevDependencyï¼‰æœªå®‰è£…ã€‚

```dockerfile
# âŒ é”™è¯¯
RUN npm ci --only=production
```

#### è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ä¸ºå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆæ„å»ºéœ€è¦ devDependenciesï¼‰ï¼š

```dockerfile
# âœ… æ­£ç¡®
RUN npm ci
```

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### Bug #3: terser not found

**æ—¶é—´**: 2025-11-27  
**é”™è¯¯**: `[vite:terser] terser not found`

#### é—®é¢˜åŸå› 

`vite.config.js` é…ç½®ä½¿ç”¨ `terser` å‹ç¼©ï¼Œä½†æœªå®‰è£… `terser` åŒ…ã€‚

```javascript
// âŒ é”™è¯¯
build: {
  minify: 'terser'
}
```

#### è§£å†³æ–¹æ¡ˆ

æ”¹ç”¨ Vite å†…ç½®çš„ `esbuild`ï¼ˆæ›´å¿«ï¼‰ï¼š

```javascript
// âœ… æ­£ç¡®
build: {
  minify: 'esbuild',
  esbuild: {
    drop: ['console', 'debugger']
  }
}
```

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ“Š æœ¬åœ°å¼€å‘ vs K8s éƒ¨ç½²

| æ–¹é¢ | æœ¬åœ°å¼€å‘ | K8s éƒ¨ç½² |
|-----|---------|---------|
| å‰ç«¯æœåŠ¡å™¨ | Vite Dev Server (5173) | Nginx (80) |
| åç«¯åœ°å€ | localhost:8000 | backend-service:8000 |
| API ä»£ç† | Vite proxy | Nginx proxy_pass |
| çƒ­æ›´æ–° | âœ… æ”¯æŒ | âŒ éœ€é‡æ–°æ„å»º |
| æ„å»º | ä¸éœ€è¦ | npm run build |
| è·¯ç”±æ¨¡å¼ | History | History + Nginx é…ç½® |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: åˆ·æ–°é¡µé¢å‡ºç° 404

**åŸå› **: Nginx æ²¡æœ‰é…ç½® SPA è·¯ç”±æ”¯æŒ  
**è§£å†³**: æ·»åŠ  `try_files $uri $uri/ /index.html;`

### Q2: API è¯·æ±‚ CORS é”™è¯¯

**åŸå› **: è·¨åŸŸé…ç½®é—®é¢˜  
**è§£å†³**:
- æ–¹æ¡ˆ 1ï¼šåœ¨ Django ä¸­é…ç½® CORSï¼ˆæ¨èï¼‰
- æ–¹æ¡ˆ 2ï¼šåœ¨ Nginx ä¸­æ·»åŠ  CORS å¤´

### Q3: é™æ€èµ„æº 404

**åŸå› **: Vite æ„å»ºåçš„è·¯å¾„é—®é¢˜  
**è§£å†³**: æ£€æŸ¥ `vite.config.js` ä¸­çš„ `base` é…ç½®

### Q4: Token æœªè‡ªåŠ¨æ·»åŠ åˆ°è¯·æ±‚

**åŸå› **: Axios æ‹¦æˆªå™¨æœªç”Ÿæ•ˆ  
**è§£å†³**: ç¡®ä¿ä½¿ç”¨å°è£…åçš„ axios å®ä¾‹

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å‰ç«¯ä¼˜åŒ–

1. **ä»£ç åˆ†å‰²**
   - ä½¿ç”¨åŠ¨æ€ import
   - é…ç½® manualChunks

2. **èµ„æºå‹ç¼©**
   - å¯ç”¨ Gzip
   - ä½¿ç”¨ esbuild å‹ç¼©

3. **ç¼“å­˜ç­–ç•¥**
   - é™æ€èµ„æºé•¿æœŸç¼“å­˜
   - API å“åº”é€‚å½“ç¼“å­˜

4. **æ‡’åŠ è½½**
   - è·¯ç”±æ‡’åŠ è½½
   - å›¾ç‰‡æ‡’åŠ è½½

### åç«¯ä¼˜åŒ–

1. **æ•°æ®åº“ä¼˜åŒ–**
   - æ·»åŠ ç´¢å¼•
   - ä½¿ç”¨è¿æ¥æ± 
   - æŸ¥è¯¢ä¼˜åŒ–

2. **ç¼“å­˜æœºåˆ¶**
   - Redis ç¼“å­˜
   - Django ç¼“å­˜æ¡†æ¶

3. **å¼‚æ­¥ä»»åŠ¡**
   - Celery å¤„ç†è€—æ—¶ä»»åŠ¡
   - æ¶ˆæ¯é˜Ÿåˆ—

4. **API ä¼˜åŒ–**
   - åˆ†é¡µ
   - å­—æ®µè¿‡æ»¤
   - æ‰¹é‡æ“ä½œ

---

## ğŸ“š å‚è€ƒèµ„æº

- [Vue3 å®˜æ–¹æ–‡æ¡£](https://cn.vuejs.org/)
- [Vite å®˜æ–¹æ–‡æ¡£](https://cn.vitejs.dev/)
- [Django å®˜æ–¹æ–‡æ¡£](https://www.djangoproject.com/)
- [Nginx é…ç½®å‚è€ƒ](https://nginx.org/en/docs/)
- [Docker æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-11-27

